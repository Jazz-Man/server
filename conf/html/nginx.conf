load_module "modules/ngx_http_geoip_module.so";
load_module                            modules/ngx_http_brotli_filter_module.so;
load_module                            modules/ngx_http_brotli_static_module.so;
load_module "modules/ndk_http_module.so";
load_module "modules/ngx_http_cache_purge_module.so";
load_module "modules/ngx_http_cookie_flag_filter_module.so";
load_module "modules/ngx_http_echo_module.so";
load_module "modules/ngx_http_naxsi_module.so";
load_module "modules/ngx_http_redis2_module.so";
load_module "modules/ngx_http_xslt_filter_module.so";
load_module "modules/ngx_http_encrypted_session_module.so";
load_module "modules/ngx_http_set_misc_module.so";


user                                   www-data;
worker_processes                       auto;
worker_rlimit_nofile                   65535;
timer_resolution                       100ms;
pcre_jit                               on;
thread_pool                            default threads=32 max_queue=65536;

events {
    worker_connections                 65535;
    multi_accept                       on;
    use                                epoll;
}

http {
    include                            mime.type;
    include                            naxsi_core.rules;

    default_type                       application/octet-stream;
    charset                            UTF-8;
    etag                               on;
    sendfile                           off;
    sendfile_max_chunk                 512k;
    send_timeout                       10s;
    tcp_nopush                         on;
    tcp_nodelay                        on;
    keepalive_timeout                  30;
    keepalive_requests                 1000;
    lingering_time                     20s;
    lingering_timeout                  5s;
    keepalive_disable                  msie6;
    reset_timedout_connection          on;
    request_pool_size                  32k;
    output_buffers                     8 256k;
    postpone_output                    1460;

    client_max_body_size               100M;
    client_body_buffer_size            128k;
    client_header_buffer_size          3m;
    large_client_header_buffers        4 256k;

    open_file_cache                    max=75000 inactive=60s;
    open_file_cache_valid              120s;
    open_file_cache_min_uses           2;
    open_file_cache_errors             off;
    open_log_file_cache                max=20000 inactive=30s min_uses=2;

    ignore_invalid_headers             on;

    geoip_country                      /usr/local/share/GeoIP/GeoIP.dat;
    geoip_city                         /usr/local/share/GeoIP/GeoLiteCity.dat;

    map_hash_bucket_size               256;
    map_hash_max_size                  4096;
    types_hash_max_size                2048;
    variables_hash_max_size            2048;

    geo                                $rate_limit {include geo.d/ratelimit.conf;}
    map                                $rate_limit $rate_limit_key {include map.d/access/*.map;}
    map                                $http_user_agent $no_logs {include map.d/logs/ua.map;}

    limit_req_zone                     $rate_limit_key zone=req_zone:10m rate=200r/s;

    upstream proxy                     {include upstream.d/proxy.conf;}
#     upstream redis                     {include upstream.d/redis.conf;}

    log_format                          blocked '$time_local: Blocked request from $http_x_real_ip $request';
    log_format                          main_ext '{ "@timestamp": "$time_iso8601", '
                                                  '"@fields": { '
                                                  '"remote_addr": "$remote_addr", '
                                                  '"remote_user": "$remote_user", '
                                                  '"status": "$status", '
                                                  '"request": "$request", '
                                                  '"request_uri": "$request_uri", '
                                                  '"request_method": "$request_method", '
                                                  '"request_time": "$request_time", '
                                                  '"request_uri_query": "$query_string", '
                                                  '"http_referrer": "$http_referer", '
                                                  '"http_user_agent": "$http_user_agent", '
                                                  '"http_forward": "$http_x_forwarded_for", '
                                                  '"http_header": "$http_x_header", '
                                                  '"body_bytes_sent": "$body_bytes_sent", '
                                                  '"geo_country": "$geoip_country_code", '
                                                  '"geo_city": "$geoip_city", '
                                                  '"server_name": "$server_name", '
                                                  '"upstream_addr": "$upstream_addr", '
                                                  '"upstream_status": "$upstream_status", '
                                                  '"upstream_response_time": "$upstream_response_time", '
                                                  '"upstream_response_length": "$upstream_response_length", '
                                                  '"upstream_cache_status": "$upstream_cache_status" } }';

    access_log                           /var/log/nginx/access.log main_ext;
    error_log                            /var/log/nginx/access.log warn;

    resolver                             1.1.1.1 8.8.8.8 8.8.4.4 valid=60s;
    resolver_timeout                     15s;

    map                                  $http_x_forwarded_proto $proxy_x_forwarded_proto {include map.d/header/proto.map;}
    map                                  $http_x_forwarded_port $proxy_x_forwarded_port {include map.d/header/port.map;}
    map                                  $scheme $proxy_x_forwarded_ssl {include map.d/header/scheme.map;}
    map                                  $host:$server_port$request_uri $noindex {include map.d/header/robot.map;}
    map                                  $request_method $skip_fetch {include map.d/srcache/*.map;}
    map                                  $sent_http_content_type $expires {include map.d/cache/*.map;}
    map                                  $request_uri $redirect_uri {include map.d/redirects/*.map;}
    map                                  $request_uri $no_cache {include map.d/nocache/*.map;}

    map                                  $http_user_agent $crawler_pre {include map.d/referrer/crawler.map;}
    map                                  $http_user_agent $bot_pre {include map.d/referrer/bot.map;}
    map                                  $args $prerender {default $bot_pre; "~(^|&)_escaped_fragment_=" 1;}

    proxy_cache_path                     /var/cache/proxy keys_zone=proxycache:10m levels=1:2 inactive=30m max_size=128m;
    proxy_cache_key                      $scheme$request_method$http_host$request_uri$slice_range;

    map                                  $request_method $purge_method {include map.d/purge/*.map;}
    geo                                  $purge_allowed {include geo.d/purge.conf;}

    geo                                  $whitelist {include geo.d/whitelist.conf;}
    map                                  $whitelist $limit_access {include map.d/access/*.map;}
    expires                              $expires;

    index                                index.html default.html;

    include                              conf.d/brotli.conf;
    include                              conf.d/gzip.conf;
    include                              conf.d/proxy.conf;
    include                              conf.d/botblocker-nginx-settings.conf;
    include                              conf.d/globalblacklist.conf;
    include                              sites-available/*.conf;
}
