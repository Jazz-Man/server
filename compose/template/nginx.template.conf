<% for module in $(ls /usr/lib/nginx/modules/); do -%>
load_module <%= modules/$module.so; %>
<% done -%>

user                                   www-data;
worker_processes                       auto;
worker_rlimit_nofile                   65535;
timer_resolution                       100ms;
pcre_jit                               on;
thread_pool                            default threads=32 max_queue=65536;

events {
    worker_connections                 65535;
    multi_accept                       on;
    use                                epoll;
}

http {
    include                            mime.type;

<% if test -f "$CONF_PREFIX/naxsi_core.rules"; then -%>
    include                            <%= $CONF_PREFIX -%>/naxsi_core.rules;
<% fi -%>

    default_type                       application/octet-stream;
    charset                            UTF-8;
    etag                               on;
    sendfile                           off;
    sendfile_max_chunk                 512k;
    send_timeout                       10s;
    tcp_nopush                         on;
    tcp_nodelay                        on;
    keepalive_timeout                  30;
    keepalive_requests                 1000;
    lingering_time                     20s;
    lingering_timeout                  5s;
    keepalive_disable                  msie6;
    reset_timedout_connection          on;
    request_pool_size                  32k;
    output_buffers                     8 256k;
    postpone_output                    1460;

    client_max_body_size               100M;
    client_body_buffer_size            128k;
    client_header_buffer_size          3m;
    large_client_header_buffers        4 256k;

    open_file_cache                    max=75000 inactive=60s;
    open_file_cache_valid              120s;
    open_file_cache_min_uses           2;
    open_file_cache_errors             off;
    open_log_file_cache                max=20000 inactive=30s min_uses=2;

    ignore_invalid_headers             on;

<% if test -f "$GEO_IP_DB_DIR/GeoIP.dat"; then -%>
    geoip_country                      <%= $GEO_IP_DB_DIR -%>GeoIP.dat;
<% fi -%>
<% if test -f "$GEO_IP_DB_DIR/GeoLiteCity.dat"; then -%>
    geoip_country                      <%= $GEO_IP_DB_DIR -%>GeoLiteCity.dat;
<% fi -%>

    map_hash_bucket_size               256;
    map_hash_max_size                  4096;
    types_hash_max_size                2048;
    variables_hash_max_size            2048;

    geo                                $rate_limit {include <%= $CONF_PREFIX -%>/geo.d/ratelimit.conf;}
    map                                $rate_limit $rate_limit_key {include <%= $CONF_PREFIX -%>/map.d/access/*.map;}
    map                                $http_user_agent $no_logs {include <%= $CONF_PREFIX -%>/map.d/logs/ua.map;}

    limit_req_zone                     $rate_limit_key zone=req_zone:10m rate=200r/s;

<% if [ "$PHP_FPM_UPSTREAM" != "false" ]; then -%>
    upstream php-fpm                   {include <%= $CONF_PREFIX -%>/upstream.d/php-fpm.conf;}
<% fi -%>
<% if [ "$NGINX_PROXY_UPSTREAM" != "false" ]; then -%>
    upstream proxy                     {include <%= $CONF_PREFIX -%>/upstream.d/proxy.conf;}
<% fi -%>
<% if [ "$REDIS_UPSTREAM" != "false" ]; then -%>
    upstream redis                     {include <%= $CONF_PREFIX -%>/upstream.d/redis.conf;}
<% fi -%>

    <%+ log.template.conf %>

    resolver                             1.1.1.1 8.8.8.8 8.8.4.4 valid=60s;
    resolver_timeout                     15s;

    map                                  $http_x_forwarded_proto $proxy_x_forwarded_proto {include <%= $CONF_PREFIX -%>/map.d/header/proto.map;}
    map                                  $http_x_forwarded_port $proxy_x_forwarded_port {include <%= $CONF_PREFIX -%>/map.d/header/port.map;}
    map                                  $http_upgrade $proxy_connection {include <%= $CONF_PREFIX -%>/map.d/header/upgrade.map;}
    map                                  $scheme $proxy_x_forwarded_ssl {include <%= $CONF_PREFIX -%>/map.d/header/scheme.map;}
    map                                  $host:$server_port$request_uri $noindex {include <%= $CONF_PREFIX -%>/map.d/header/robot.map;}
    map                                  $request_method $skip_fetch {include <%= $CONF_PREFIX -%>/map.d/srcache/*.map;}

    map                                  $sent_http_content_type $expires {include <%= $CONF_PREFIX -%>/map.d/cache/expires.map;}
    map                                  $http_cookie $php_session_cookie {include <%= $CONF_PREFIX -%>/map.d/cache/phpsession.map;}

    map                                  $request_uri $redirect_uri {include <%= $CONF_PREFIX -%>/map.d/redirects/*.map;}
    map                                  $request_uri $no_cache {include <%= $CONF_PREFIX -%>/map.d/nocache/nocache.map;}
    map                                  $http_cookie $no_cache {include <%= $CONF_PREFIX -%>/map.d/nocache/cookie.map;}

    map                                  $http_user_agent $crawler_pre {include <%= $CONF_PREFIX -%>/map.d/referrer/crawler.map;}
    map                                  $http_user_agent $bot_pre {include <%= $CONF_PREFIX -%>/map.d/referrer/bot.map;}
    map                                  $args $prerender {default $bot_pre; "~(^|&)_escaped_fragment_=" 1;}

    fastcgi_cache_path                   <%= $CACHE_PREFIX -%>/fastcgi keys_zone=fastcgicache:10m levels=1:2 inactive=30m max_size=64m;
    fastcgi_cache_key                    $scheme$request_method$host$request_uri$php_session_cookie;

    proxy_cache_path                     <%= $CACHE_PREFIX -%>/proxy keys_zone=proxycache:10m levels=1:2 inactive=30m max_size=64m;
    proxy_cache_key                      $scheme$request_method$http_host$request_uri;

    map                                  $request_method $purge_method {include <%= $CONF_PREFIX -%>/map.d/purge/*.map;}
    geo                                  $purge_allowed {include <%= $CONF_PREFIX -%>/geo.d/purge.conf;}

    geo                                  $whitelist {include <%= $CONF_PREFIX -%>/geo.d/whitelist.conf;}
    map                                  $whitelist $limit_access {include <%= $CONF_PREFIX -%>/map.d/access/*.map;}
    expires                              $expires;

    index                                app.php index.php index.html default.html;

    include                              <%= $CONF_PREFIX -%>/conf.d/brotli.conf;
    include                              <%= $CONF_PREFIX -%>/conf.d/gzip.conf;
    include                              <%= $CONF_PREFIX -%>/conf.d/proxy.conf;
    include                              <%= $CONF_PREFIX -%>/conf.d/botblocker-nginx-settings.conf;
    include                              <%= $CONF_PREFIX -%>/conf.d/globalblacklist.conf;
    include                              <%= $CONF_PREFIX -%>/sites-available/*.conf;
}